{
    "contents" : "\nrm(list=ls())\nlibrary(survey)\nlibrary(foreign)\n\n#---------------------------------------#\n# Paths\n#---------------------------------------#\n\npath <- \"J:/Work/Statistik/Kolb/Paper/Gewichtung/data\"\n\n#----------------------------------------#\n# How to get function body\n#----------------------------------------#\n\nmethods(svydesign)\nsurvey:::svydesign.default\nsurvey:::svydesign.character\n\n\nmethods(svymean)\nsurvey:::svymean.survey.design\n\n\n#----------------------------------------#\n# compute an example\n#----------------------------------------#\n\nsetwd(path)\nx_West <- read.dta(\"ALLB10_xWest_abitur.dta\")\nx <- x_West$ys_1\nx1 <- x <- x_West$ys_1\ndesign <-svydesign(id=~v762+ID,prob=~prob1+prob2,data=x_West)\n\n#----------------------------------------#\n# svymean - 1st part\n#----------------------------------------#\n\n\nx_form <- ~x\nmf <- model.frame(x_form, design$variables, na.action = na.pass)\nxx <- lapply(attr(terms(x_form), \"variables\")[-1], function(tt) model.matrix(eval(bquote(~0 + \n                                                                                     .(tt))), mf))\n\ncols <- sapply(xx, NCOL)\nx <- matrix(nrow = NROW(xx[[1]]), ncol = sum(cols))\nscols <- c(0, cumsum(cols))\nfor (i in 1:length(xx)) {\n  x[, scols[i] + 1:cols[i]] <- xx[[i]]\n}\ncolnames(x) <- do.call(\"c\", lapply(xx, colnames))\n\n\npweights <- 1/design$prob\npsum <- sum(pweights)\naverage <- colSums(x * pweights/psum)\nx <- sweep(x, 2, average)\n\n#----------------------------------------#\n# svyCprod\n#----------------------------------------#\n\n# v <- svyCprod(x=x * pweights/psum, \n#               strata=design$strata, \n#               psu=design$cluster[[1]], \n#               fpc=design$fpc, \n#               nPSU=design$nPSU, \n#               certainty=design$certainty, \n#               postStrata=design$postStrata)\n\nx=x * pweights/psum\nstrata=design$strata\npsu=design$cluster[[1]]\nfpc=design$fpc\nnPSU=design$nPSU\ncertainty=design$certainty\npostStrata=design$postStrata\nlonely.psu = getOption(\"survey.lonely.psu\")\n\n\nx <- as.matrix(x)\nn <- NROW(x)\n\nstrata <- as.character(strata)\n\ncertainty <- rep(FALSE, length(strata))\nnames(certainty) <- strata\n\nx <- rowsum(x, psu, reorder = FALSE)\nstrata <- strata[!duplicated(psu)]\nn <- NROW(x)\n\nobsn <- table(strata)\n\nstrata.means <- drop(rowsum(x, strata, reorder = FALSE))/drop(rowsum(rep(1, \n                                                                         n), strata, reorder = FALSE))\nstrata.means <- matrix(strata.means, ncol = NCOL(x))\nx <- x - strata.means[match(strata, unique(strata)), , drop = FALSE]\n\np <- NCOL(x)\nv <- matrix(0, p, p)\nss <- unique(strata)\nfor (s in ss) {\n  this.stratum <- strata %in% s\n  this.n <- nPSU[match(s, names(nPSU))]\n  this.df <- this.n/(this.n - 1)\n  if (is.null(fpc)) {\n    this.fpc <- 1\n  }else {\n    this.fpc <- fpc$sampsize[, 2][fpc$sampsize[, 1] == as.character(s)]\n    this.fpc <- (this.fpc - this.n)/this.fpc\n  }\n  xs <- x[this.stratum, , drop = FALSE]\n  this.certain <- certainty[names(certainty) %in% s]\n  lonely.psu <- match.arg(lonely.psu, c(\"remove\", \"adjust\", \n                                        \"fail\", \"certainty\", \"average\"))\n    v <- v + crossprod(xs) * this.df * this.fpc\n}\n\n\n#----------------------------------------#\n# svymean - 2nd part\n#----------------------------------------#\n\n\n\n\nna.rm = FALSE\nnobs <- NROW(design$cluster)\nvsrs1 <- svyvar(x1, design, na.rm = na.rm)/nobs\nvsrs <- vsrs1 * (psum - nobs)/psum\n\ndeff <- v/vsrs\n\n\n#----------------------------------------#\n# Links\n#----------------------------------------#\n\n# https://stat.ethz.ch/pipermail/r-help/2008-January/152582.html\n",
    "created" : 1437114997832.000,
    "dirty" : false,
    "encoding" : "UTF-8",
    "folds" : "",
    "hash" : "890963748",
    "id" : "BF4584F3",
    "lastKnownWriteTime" : 1437041968,
    "path" : "J:/Work/Statistik/Kolb/Paper/Gewichtung/Rcode/rcodePaper/LumleyPackage/Example_svymean.R",
    "project_path" : null,
    "properties" : {
    },
    "relative_order" : 6,
    "source_on_save" : false,
    "type" : "r_source"
}
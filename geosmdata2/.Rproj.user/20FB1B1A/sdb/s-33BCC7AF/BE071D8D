{
    "contents" : "# ALLBUS10.R\n# Siegfried Gabler\n# 10.12.2014\n# R version 3.1.2 (2014-10-31) -- \"Pumpkin Helmet\"\n# Platform: x86_64-w64-mingw32/x64 (64-bit)\n\n# mij Stichprobenumfang variierend bei wiederholter Auswahl PSU\n\nrm(list=ls())\nlibrary(foreign)\n\n# block_vd2 quadrierte Distanzen für Einheiten aus verschiedenen PSUs  # geändert 11.12.2014\n# y   -- nx1 Vektor\n# PSU -- nx1 Vektor: Indentifikator für PSU\nblock_vd2 <- function(y,PSU){\n  d=0\n  for(i in 1:length(PSU)){\n    ym1 <- y[i]\n    ym2 <- y[PSU!=PSU[i]]\n    d   <- d+sum(outer(ym1,ym2,\"-\")^2)\n  }\n  return(d)\n}\n\n# block_mean(y,SP): Mittelwerte der y-Werte in den SamplePoints\nblock_mean <- function(y,SP){aggregate(y,by=list(SP),FUN=\"mean\")}\n\n# block_sih(y,PSU): Varianzen der y-Werte in den SamplePoints\nblock_sih <- function(y,SP){aggregate(y,by=list(SP),FUN=\"var\")  }\n\n#######################################\n#         PSU       -- nx1  PSU-Kennung in Stichprobe\n#         SSUi      -- mhx1 Vektor Stichprobe in ausgewählter PSU im i-ten Zug, i=1,..,n;\n#         ss_list <- list(PSU,SSU1,...,SSUn)\n#######################################\n# sig_hat.R\n# Input:  ys        -- sum(length(SSUi)) Stichprobenvektor der y-Werte\n\n#         Mhs       -- nx1 Vektor Umfänge der ausgewählten PSUs\n#         sslist    -- s. oben\n#         N         -- Zahl der PSUs in Gesamtheit\n#         K         -- Zahl aller SSUs in Gesamtheit\n# Output: schaetzer -- Schätzer für Y_bar\n#         v_hat     -- Varianzschätzer\n#         sig_hat   -- Schätzer für sigma^2\n#         S2        -- Stichprobenvarianz\n\nsig_hat <- function(ys,Mhs,ss_list,N,K){\n  n     <- length(ss_list)-1  # Zahl der ausgewählten PSUs\n  s_PSU <- unlist(ss_list[[1]]) # i-te Stelle gibt gezogene PSU im i-ten Zug an, i=1,..,n\n\n  mhs      <- rep(0,n)         # Stichprobenumfänge in den ausgewählten PSUs\n  for(i in 1:n){ mhs[i] <- length(ss_list[[i+1]]) }\n\n  w        <- prod(Mhs/K)/prod(choose(Mhs,mhs)) # Gewicht für Stichproben\n  S2       <- var(ys)\n\n  PSU_v    <- rep(0, length(ys))  # geändert 11.12.2014\n  for(i in 1:n){  PSU_v[ss_list[[i+1]]] <- i } # Neunummerierung von 1,...,n\n\n  ybar_i  <- block_mean(ys,PSU_v)[,2]\n  sih2    <- block_sih(ys,PSU_v)[,2]\n\n  Hi      <- table(s_PSU)\n  Hi      <- Hi[as.character(s_PSU)]  # Hi gibt für jede ausgewählte PSU die Häufigkeit an, mit der sie in der Stichprobe vorkommt\n  e       <- sum(ybar_i)/n   # Schätzer für ty/K\n  v1      <- 1/(n*K)*sum( (Mhs-1)*sih2 )\n  v2      <- sum( (n-Hi)*( (mhs-1)/mhs*sih2) )/(n*(n-1))\n  v3      <- block_vd2(ybar_i,s_PSU)/(2*n*(n-1))\n  sig_hat <- v1+v2+v3 # Schätzer für sigma^2\n  v_hat   <- sum( (ybar_i - sum(ybar_i)/n)^2 )/(n*(n-1))  # Varianzschätzung des Schätzers für Y_bar\n\nreturn(list(e,v_hat,sig_hat,S2,w))\n}\n\n######################################################\n# Beispiel 1 im Paper\nMh      <- c(2,2)\ny       <- 1:4\n\nss_list <- list(c(1,1),c(1,2),c(1,2))\nys      <- y[c(ss_list[[2]],ss_list[[3]])]\nMhs     <- Mh[unlist(ss_list[[1]])]\nN       <- 2\nK       <- 4\n\nerg <- sig_hat(ys,Mhs,ss_list,N,K)\ncat(\npaste(\" Schätzer für mean    =\",erg[[1]]),\"\\n\",\npaste(\"Varianzschätzer      =\",erg[[2]]),\"\\n\",\npaste(\"Schätzer für sigma^2 =\",erg[[3]]),\"\\n\",\npaste(\"Stichprobenvarianz   =\",erg[[4]]),\"\\n\",\npaste(\"Gewicht              =\",erg[[5]]),\"\\n\")\n########################\nss_list <- list(c(1,2),c(1,2),c(3,4))\nys      <- y[c(ss_list[[2]],ss_list[[3]])]\n\nMhs     <- Mh[unlist(ss_list[[1]])]\nN       <- 2\nK       <- 4\n\nerg <- sig_hat(ys,Mhs,ss_list,N,K)\ncat(\n  paste(\" Schätzer für mean    =\",erg[[1]]),\"\\n\",\n  paste(\"Varianzschätzer      =\",erg[[2]]),\"\\n\",\n  paste(\"Schätzer für sigma^2 =\",erg[[3]]),\"\\n\",\n  paste(\"Stichprobenvarianz   =\",erg[[4]]),\"\\n\",\n  paste(\"Gewicht              =\",erg[[5]]),\"\\n\")\n########################\nss_list <- list(c(2,2),c(3,4),c(3,4))\nys      <- y[c(ss_list[[2]],ss_list[[3]])]\n\nMhs     <- Mh[unlist(ss_list[[1]])]\nN       <- 2\nK       <- 4\n\nerg <- sig_hat(ys,Mhs,ss_list,N,K)\ncat(\n  paste(\" Schätzer für mean    =\",erg[[1]]),\"\\n\",\n  paste(\"Varianzschätzer      =\",erg[[2]]),\"\\n\",\n  paste(\"Schätzer für sigma^2 =\",erg[[3]]),\"\\n\",\n  paste(\"Stichprobenvarianz   =\",erg[[4]]),\"\\n\",\n  paste(\"Gewicht              =\",erg[[5]]),\"\\n\")\n########################\n# Beispiel 2\n########################\nn  <- 2\nN  <- 3\nMh <- c(4,6,5)\ny <- 1:15\n\nss_list <- list(c(2,3),c(5,6,8,10),c(11,14))  # Beispiel 3 Nr 544\nys      <- y[c(ss_list[[2]],ss_list[[3]])]\nMhs     <- Mh[unlist(ss_list[[1]])]\nN       <- 3\nK       <- 15\nerg <- sig_hat(ys,Mhs,ss_list,N,K)\ncat(\n  paste(\" Schätzer für mean    =\",erg[[1]]),\"\\n\",\n  paste(\"Varianzschätzer      =\",erg[[2]]),\"\\n\",\n  paste(\"Schätzer für sigma^2 =\",erg[[3]]),\"\\n\",\n  paste(\"Stichprobenvarianz   =\",erg[[4]]),\"\\n\",\n  paste(\"Gewicht              =\",erg[[5]]),\"\\n\")\n\n\n########################\n# ALLBUS-Daten\n########################\n\npath <- \"J:/Work/Statistik/Kolb/Paper/Gewichtung/data\"\n\n# path <- \"D:/paper/2015/Howto/\"\nsetwd(path)\ndat_zus <- read.spss(\"zusatz_cs_siegfried_2010_neu.sav\", use.value.labels = FALSE,to.data.frame = TRUE)\n# v2  Numeric\t8\t2\tListe / Laufende\tNone\tNone\n# ZPPLZ\tNumeric\t5\t0\tPLZ\tNone\tNone\n# netto2010\tNumeric\t8\t2\t\tNone\tNone\n# Bevölkerungab18Stand31.12.2007\tNumeric\t11\t0\tBevölkerung ab 18, Stand 31.12.2007\tNone\tNone\n# AnzahlPointsinderStichprobe\tNumeric\t11\t0\tAnzahl Points in der Stichprobe\tNone\tNone\n\n# Bevölkerungab18Stand31.12.2007  ANGEBLICH KEINE MISSINGS; in zusatz_cs_siegfried_2010.sav gibt aber 26 Missings in Gemeinde POING in Bayern\n# keine Missings mehr in zusatz_cs_siegfried_2010_neu.sav\n\ndat     <- read.spss(\"allb10_cs.sav\", use.value.labels = FALSE,to.data.frame = TRUE)\n# v2  Numeric\t4\t0\tIDENTIFIKATIONSNUMMER DES BEFRAGTEN\tNone\tNone\t8\tRight\tScale\tInput\n# v4\tNumeric\t1\t0\tFRAGEBOGENSPLIT F020\t{1, SPLIT 1}...\tNone\t8\tRight\tNominal\tInput\n# v5\tNumeric\t1\t0\tERHEBUNGSGEBIET <WOHNGEBIET>: WEST - OST\t{1, ALTE BUNDESLAENDER}...\tNone\t8\tRight\tNominal\tInput\n# v34\tNumeric\t1\t0\tGERECHTER ANTEIL A.LEBENSSTANDARD,BEFR.?\t{1, SEHR VIEL WENIGER}...\t7 - HI\t8\tRight\tNominal\tInput\n# v83\tNumeric\t1\t0\tANZ. GENANNTER NETZWERKPERS. <SPLIT 1>\t{0, KEINE PERSON}...\t6 - HI\t8\tRight\tNominal\tInput\n# v301\tNumeric\t3\t0\tALTER: BEFRAGTE<R>\t{999, KEINE ANGABE}...\t997 - HI\t8\tRight\tScale\tInput\n# v314\tNumeric\t2\t0\tBEFR.: STAATSBUERGERSCHAFT, 1. NENNUNG\t{1, DEUTSCHLAND}...\t97 - HI\t8\tRight\tNominal\tInput\n# v318\tNumeric\t2\t0\tAUSLAENDER: MEHR LEBENSSTILANPASSUNG\t{0, TRIFFT NICHT ZU}...\t97 - HI, 0\t8\tRight\tNominal\tInput\n# v319\tNumeric\t2\t0\tAUSLAEND.:WIEDER HEIM BEI KNAPPER ARBEIT\t{0, TRIFFT NICHT ZU}...\t97 - HI, 0\t8\tRight\tNominal\tInput\n# v320\tNumeric\t2\t0\tAUSLAENDER: POLIT.BETAETIGUNG UNTERSAGEN\t{0, TRIFFT NICHT ZU}...\t97 - HI, 0\t8\tRight\tNominal\tInput\n# v321\tNumeric\t2\t0\tAUSLAENDER: SOLLTEN UNTER SICH HEIRATEN\t{0, TRIFFT NICHT ZU}...\t97 - HI, 0\t8\tRight\tNominal\tInput\n# v327\tNumeric\t2\t0\tALLGEMEINER SCHULABSCHLUSS\t{1, OHNE ABSCHLUSS}...\t97 - HI\t8\tRight\tNominal\tInput\n# v298\tNumeric\t1\t0\tGESCHLECHT, BEFRAGTE<R>\t{1, MANN}...\tNone\t8\tRight\tNominal\tInput\n# v762\tNumeric\t3\t0\t<VIRTUELLE> POINT NUMMER\tNone\tNone\t8\tRight\tScale\tInput\n# v942\tNumeric\t6\t0\tINTERVIEWER<IN>-NUMMER\tNone\tNone\t8\tRight\tScale\tInput\n# v974\tNumeric\t2\t0\tBIK-REGIONEN\t{1, BIS 1.999 EINWOHNER}...\tNone\t8\tRight\tNominal\tInput\n# v975\tNumeric\t3\t0\tBUNDESLAND, IN DEM BEFRAGTE<R> WOHNT\t{10, SCHLESWIG-HOLSTEIN}...\tNone\t8\tRight\tScale\tInput\n# v976\tNumeric\t1\t0\tREGIERUNGSBEZIRK\t{0, NICHT ENTHALTEN}...\tNone\t8\tRight\tNominal\tInput\n# v977\tNumeric\t11\t9\tPERSONENBEZOGENES OST-WEST-GEWICHT\t{.594943761, NEUE BUNDESLAENDER}...\tNone\t8\tRight\tNominal\tInput\n# p_inklusion\tNumeric\t8\t2\t\tNone\tNone\t13\tRight\tNominal\tInput\n# gewfake\tNumeric\t8\t2\t\tNone\tNone\t10\tRight\tNominal\tInput\n# deutsch\tNumeric\t8\t2\t\tNone\tNone\t10\tRight\tNominal\tInput\n# abitur\tNumeric\t8\t2\t\tNone\tNone\t10\tRight\tNominal\tInput\n# regbez\tNumeric\t8\t2\t\tNone\tNone\t10\tRight\tScale\tInput\n# bikbula\tNumeric\t8\t2\t\tNone\tNone\t10\tRight\tScale\tInput\n# bikregbez\tNumeric\t8\t2\t\tNone\tNone\t11\tRight\tScale\tInput\n# pointint\tNumeric\t8\t2\t\tNone\tNone\t10\tRight\tScale\tInput\n\n\nx   <- merge(dat,dat_zus,by.x=\"v2\",by.y=\"v2\")  # Mergen der beiden Dateien nach v2\nMi  <- x[,ncol(x)-1]  # 26 NA\n# Mi[is.na(Mi)] <- 10124  # Email Michael Blohm 11.12.2014\nu   <- unique(Mi)\nn   <- length(Mi)\nPSU <- Mi\nfor(i in 1:n){\n  PSU <- replace(PSU,(1:n)[PSU==u[i]],i)\n}\nx   <- cbind(x,PSU)\n\nVariable <- \"abitur\"   # Abitur\nVariable <- \"v301\"     # Alter\nVariable <- \"v975\"     # Bundesland\nVariable <- \"deutsch\"  # 1=deutsch; 0 sonst\nVariable <- \"v318\"     # AUSLAENDER: MEHR LEBENSSTILANPASSUNG 0,...,7\nVariable <- \"v321\"     # AUSLAENDER: SOLLTEN UNTER SICH HEIRATEN  0,...,7\nVariable <- \"v327\"     # ALLGEMEINER SCHULABSCHLUSS 1,...,7\n\nnr       <- match(Variable,colnames(x))\nx        <- subset(x,is.na(x[,nr])==0)  # Zeilen mit missings in Variable werden gelöscht\n\n\n# West\nx_West    <- subset(x,x$v5==1)\nPSU_West  <- unique(x_West$PSU)\nSP_West   <- x_West$v762\nuSP_West  <- unique(SP_West)\nn_West    <- nrow(x_West) # Zahl der ausgewählten Personen im Datensatz\nMhi_West  <- subset(Mi,x$v5==1)\nMhs_West  <- Mi[match(uSP_West,SP_West)]\nPSU_s     <- x_West$PSU[match(uSP_West,SP_West)]\nN_West    <- 8497      # Zahl der Gemeinden (PSUs); aus GEM2007.sav + Berlin-West\nK_West    <- 55701259  # Zahl der 18+ Einwohner (SSUs); aus 6706109495_Allokationsprotokoll.txt\nMh_West   <- 111       # Zahl der Sample Points; aus 6706109495_Allokationsprotokoll.txt\nys_West   <- x_West[,nr]\nys_West   <- as.numeric(x_West[,nr]==6)\n\nss_list_West   <- list(PSU_s)\nfor(i in 1:length(uSP_West)){\n  ss_list_West[[i+1]] <- (1:nrow(x_West))[SP_West==uSP_West[i]]\n}\n\nerg_West <- sig_hat(ys_West,Mhs_West,ss_list_West,N_West,K_West)\ncat(\n  paste(\" Schätzer für mean       =\",erg_West[[1]]),\"\\n\",\n  paste(\"Varianzschätzer         =\",erg_West[[2]]),\"\\n\",\n  paste(\"Schätzer für sigma^2    =\",erg_West[[3]]),\"\\n\",\n  paste(\"Stichprobenvarianz      =\",erg_West[[4]]),\"\\n\",\n  paste(\"Schätzer für Deff       =\",erg_West[[2]]/erg_West[[3]]*n_West),\"\\n\",\n  paste(\"Schätzer für Deff(s^2)  =\",erg_West[[2]]/erg_West[[4]]*n_West),\"\\n\",\n  paste(\"Gewicht                 =\",erg_West[[5]]),\"\\n\"\n)\n\n# Ost\nx_Ost    <- subset(x,x$v5==2)\nPSU_Ost  <- unique(x_Ost$PSU)\nSP_Ost   <- x_Ost$v762\nuSP_Ost  <- unique(SP_Ost)\nn_Ost    <- nrow(x_Ost) # Zahl der ausgewählten Personen im Datensatz\nMhi_Ost  <- subset(Mi,x$v5==1)\nMhs_Ost  <- Mi[match(uSP_Ost,SP_Ost)]\nPSU_s    <- x_Ost$PSU[match(uSP_Ost,SP_Ost)]\nN_Ost    <- 3767      # Zahl der Gemeinden; aus GEM2007.sav + Berlin-Ost\nK_Ost    <- 12546495  # Zahl der 18+ Einwohner; aus 6706109495_Allokationsprotokoll.txt\nMh_Ost   <- 51        # Zahl der Sample Points; aus 6706109495_Allokationsprotokoll.txt\nys_Ost   <- x_Ost[,nr]\n# ys_Ost   <- as.numeric(x_Ost[,nr]==0)\n\nss_list_Ost   <- list(PSU_s)\nfor(i in 1:length(uSP_Ost)){\n  ss_list_Ost[[i+1]] <- (1:nrow(x_Ost))[SP_Ost==uSP_Ost[i]]\n}\n\nerg_Ost <- sig_hat(ys_Ost,Mhs_Ost,ss_list_Ost,N_Ost,K_Ost)\ncat(\n  paste(\" Schätzer für mean       =\",erg_Ost[[1]]),\"\\n\",\n  paste(\"Varianzschätzer         =\",erg_Ost[[2]]),\"\\n\",\n  paste(\"Schätzer für sigma^2    =\",erg_Ost[[3]]),\"\\n\",\n  paste(\"Stichprobenvarianz      =\",erg_Ost[[4]]),\"\\n\",\n  paste(\"Schätzer für Deff       =\",erg_Ost[[2]]/erg_Ost[[3]]*n_Ost),\"\\n\",\n  paste(\"Schätzer für Deff(s^2)  =\",erg_Ost[[2]]/erg_Ost[[4]]*n_Ost),\"\\n\",\n  paste(\"Gewicht                 =\",erg_Ost[[5]]),\"\\n\"\n)\n",
    "created" : 1435912661049.000,
    "dirty" : false,
    "encoding" : "UTF-8",
    "folds" : "",
    "hash" : "3556375823",
    "id" : "BE071D8D",
    "lastKnownWriteTime" : 1435565700,
    "path" : "J:/Work/Statistik/Kolb/Paper/Gewichtung/Rcode/ALLBUS10.R",
    "project_path" : null,
    "properties" : {
    },
    "relative_order" : 6,
    "source_on_save" : false,
    "type" : "r_source"
}
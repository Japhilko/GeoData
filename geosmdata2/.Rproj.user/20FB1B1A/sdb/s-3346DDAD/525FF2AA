{
    "contents" : "###################################################\n# Use the osm api xapi with R\n# Jan-Philipp Kolb\n# Tue Jun 16 09:30:28 2015\n#\n###################################################\n\n#------------------------------------------#\n# In general\n#------------------------------------------#\n\nauthor <- \"Jan-Philipp Kolb\"\nscriptname <- \"rOSM_E_USExapi.R\"\n\n#------------------------------------------#\n# Libraries\n#------------------------------------------#\n\nlibrary(XML)\nlibrary(RCurl)\nlibrary(ggmap)\nlibrary(rgdal)\n\nlibrary(geosmdata2)\n\n#------------------------------------------#\n# paths\n#------------------------------------------#\n\ndata.path <- \"D:/Daten/Daten/GeoDaten/XAPI\"\ndata.path2 <- \"D:/Daten/Daten/GeoDaten\"\nrcode.path <- \"J:/Work/Statistik/Kolb/Paper/UseOSMdata/rcode\"\ngraph.path <- \"J:/Work/Statistik/Kolb/VortrÃ¤ge/20150617_Forschungsboerse/Folien/figure\"\ngithub.path <- \"C:/Users/kolbjp/Documents/GitHub/GeoData\"\n\n#------------------------------------------#\n# Functions\n#------------------------------------------#\n\n\ncreate_bbox <- function(location,box.value){\n  gc_loc <- geocode(location)\n\n  gc_loc_min <- gc_loc - box.value\n  gc_loc_max <- gc_loc + box.value\n  bbox_x <- paste(gc_loc_min$lon,gc_loc_min$lat,gc_loc_max$lon,gc_loc_max$lat,sep=\",\")\n}\n\n\ngetDat_overpass <- function(object_x,loc1,bv){\n  bb_SK <- create_bbox(loc1,bv)\n  return(xmlParse(paste(\"http://www.overpass-api.de/api/xapi?way[bbox=\",bb_SK,\"][\",object_x,\"]\",\n                                  sep=\"\")))\n}\n\n# following function readOSMCoordValue is available via:\n\n# http://www.ls4.soziologie.uni-muenchen.de/personen/wiss_ma/bauer_johannes/veroef_und_vortr/additional_information/index.html\n\nreadOSMCoordValue <- function( value, OSM.Data )\n{\n  dataStorage <- matrix( NA, ncol = 2, nrow = 1 )\n\n  # Way-nodes\n  data_way <- NULL\n  way_id  <- unlist( xpathApply( OSM.Data, paste( \"//tag[@v = '\", value, \"']/parent::way/@ id\", sep = \"\" ) ) )\n  if( length( way_id ) > 0 )\n  {\n    for(i in 1:length( way_id ) )\n    {\n      p.node    <- paste( \"//way[@id = '\", way_id[i] ,\"']/nd/@ref\", sep = \"\" )\n      way_node_save\t<- as.numeric( xpathApply( OSM.Data, p.node ) )\n      ifelse( length( way_node_save ) == 0, way_node \t<- NA, way_node <- way_node_save )\n\n      # Datensatz zusammenf?gen\n      data_way[[ i ]]\t<- way_node\n    }\n\n    dataStorage <- matrix( NA, ncol = 2, nrow = length( data_way ) )\n    # Koordinaten\n    for(i in 1:length( data_way ) )\n    {\n      nodes\t<- data_way[[ i ]]\n      p.lat\t<- paste(\"//node[@id = \", nodes  ,\"]/@ lat\", sep = \"\")\n      p.lon\t<- paste(\"//node[@id = \", nodes  ,\"]/@ lon\", sep = \"\")\n      lat <- lon <- NULL\n      for( j in 1:length(nodes ) )\n      {\n        lat[ j ] \t<- as.numeric( xpathApply( OSM.Data, p.lat[ j ] ) )\n        lon[ j ] \t<- as.numeric( xpathApply( OSM.Data, p.lon[ j ] ) )\n      }\n      dataStorage[ i, ] <- c( mean( lon ), mean( lat ) )\n    }\n  }\n\n  node_lat <- as.numeric( unlist( xpathApply( OSM.Data, paste( \"//tag[@v = '\", value, \"']/parent::node/@ lat\", sep = \"\" ) ) ) )\n  node_lon <- as.numeric( unlist( xpathApply( OSM.Data, paste( \"//tag[@v = '\", value, \"']/parent::node/@ lon\", sep = \"\" ) ) ) )\n\n  if( length( node_lat ) > 0 ) dataStorage <- rbind( dataStorage, cbind( lon = node_lon, lat = node_lat ) )\n  rownames( dataStorage ) <- NULL\n  colnames( dataStorage ) <- c( \"lon\", \"lat\" )\n\n  if( all( is.na( dataStorage ) ) )\n  {\n    cat( \"no matches\" )\n  }else{ return <- na.omit( dataStorage ); return }\n}\n\n#------------------------------------------#\n# Using geosmdata2\n#------------------------------------------#\n\nobject_x <- \"amenity=kindergarten\"\nbbox_x <- \"8.4178134,49.41014103,8.59395996,49.58984376\"\nx_MA <- xmlParse(paste(\"http://www.overpass-api.de/api/xapi?way[bbox=\",bbox_x,\"][\",object_x,\"]\",\n                             sep=\"\"))\n\noverpass_x <- extract_info_op(OSM.Data=x_MA,value=\"kindergarten\")\n\n\n#------------------------------------------#\n# Download information\n#------------------------------------------#\n\n\nx_overpass <- getDat_overpass(object_x=\"leisure=garden\",loc1=\"Mannheim\",bv=0.1)\n\nx_root = xmlRoot(x_overpass)\n\nx_childs <- xmlChildren(x_root)\n\nNodes <- getNodeSet(x_root,\"//node\")\n\nWays <- getNodeSet(x_root,\"//way\")\n\nx_df <- data.frame(id=rep(NA,length(Ways)))\n\nfor (i in 1:length(Ways)){\n  x_df$id[i] <- xmlAttrs(Ways[[i]])\n}\n\nx_df2 <- data.frame(id=rep(NA,length(Nodes)),lat=rep(NA,length(Nodes)),lon=rep(NA,length(Nodes)))\n\nfor (i in 1:length(Nodes)){\n  x_df2[i,]<-  xmlAttrs(Nodes[[i]])\n}\n\n\nx_df2$lat <- as.numeric(x_df2$lat)\nx_df2$lon <- as.numeric(x_df2$lon)\n\n#------------------------------------------#\n# Use zip codes to define bounding box\n#------------------------------------------#\n\n\nsetwd(data.path2)\nPLZ <- readOGR (\"post_pl.shp\",\"post_pl\")\nMA <- PLZ[PLZ@data$PLZORT99==\"Mannheim\",]\nbMA <- bbox(MA)\n\nobject_x=\"amenity=school\"\n  # y - lat\n  # x - lon\nbbox_x <- paste(bMA[\"x\",\"min\"],bMA[\"y\",\"min\"],bMA[\"x\",\"max\"],bMA[\"y\",\"max\"],sep=\",\")\n\nschools_MA <- xmlParse(paste(\"http://www.overpass-api.de/api/xapi?way[bbox=\",bbox_x,\"][\",object_x,\"]\",\n               sep=\"\"))\n\n\nschool_FF <- readOSMCoordValue( \"school\", schools_MA )\n\nschool_FF <- data.frame(school_FF)\n\nsetwd(data.path)\nsaveXML(schools_MA,\"schools_MA.xml\")\n#------------------------------------------#\n# Draw a map\n#------------------------------------------#\n\n\nMAmap <- qmap(\"Mannheim\",zoom=13)\n\nsetwd(graph.path)\npng(\"MAmap_schools.png\")\nMAmap +\n  geom_point(aes(x = lon, y = lat),\n             data = school_FF)\ndev.off()\n\n\n#------------------------------------------#\n# Visualize bounding box\n#------------------------------------------#\n\nplot(MA)\nabline(v=\"8.417813\")\nabline(h=\"49.410141\")\nabline(h=\"49.58984\")\nabline(v=\"8.59396\")\n\n#------------------------------------------#\n# Links\n#------------------------------------------#\n",
    "created" : 1434464231917.000,
    "dirty" : false,
    "encoding" : "UTF-8",
    "folds" : "",
    "hash" : "3667552570",
    "id" : "525FF2AA",
    "lastKnownWriteTime" : 1434464619,
    "path" : "J:/Work/Statistik/Kolb/Paper/UseOSMdata/rcode/rOSM_F_USEoverpassAPI.R",
    "project_path" : null,
    "properties" : {
    },
    "relative_order" : 8,
    "source_on_save" : false,
    "type" : "r_source"
}
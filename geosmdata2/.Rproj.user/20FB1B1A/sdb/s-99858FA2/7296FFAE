{
    "contents" : "#---------------------------------------#\n# Survey Weighting with ALLBUS data\n# Jan-Philipp Kolb und Siegfried Gabler\n# Mon Jun 29 10:38:12 2015\n#---------------------------------------#\n# R version 3.1.2 (2014-10-31) -- \"Pumpkin Helmet\"\n# Platform: x86_64-w64-mingw32/x64 (64-bit)\n#---------------------------------------#\n# Generalities\n#---------------------------------------#\n\nrm(list=ls())\nauthor <- \"Siegfried Gabler, Jan-Philipp Kolb\"\nscriptname <- \"WeightALL_C_ComputeWeights.R\"\n\n#---------------------------------------#\n# libraries\n#---------------------------------------#\n\nlibrary(xtable) # to produce a LaTeX table\nlibrary(knitr)\n#---------------------------------------#\n# Paths\n#---------------------------------------#\n\npath <- \"J:/Work/Statistik/Kolb/Paper/Gewichtung/data\"\nr.path <- \"J:/Work/Statistik/Kolb/Paper/Gewichtung/Rcode/rcodePaper\"\n\n#---------------------------------------#\n# Read data\n#---------------------------------------#\n\nsetwd(path)\nload(\"ALLBUSweights.RData\")\nx_ALL <- x\nload(\"ALLBUS10Vars.RData\")\n\n#---------------------------------------#\n# Read functions\n#---------------------------------------#\n\nsetwd(r.path)\nsource(\"WeightALL_B_functions.R\")\n\n#---------------------------------------#\n# Choose one variable\n#---------------------------------------#\n\n\nDescr <- c(\"Abitur\",\"Alter\",\"Bundesland\",\"1=deutsch; 0 sonst\",\"AUSLAENDER: MEHR LEBENSSTILANPASSUNG 0,...,7\",\n           \"AUSLAENDER: SOLLTEN UNTER SICH HEIRATEN  0,...,7\",\"ALLGEMEINER SCHULABSCHLUSS 1,...,7\")\nVariablen <- c(\"abitur\",\"v301\",\"v975\",\"deutsch\",\"v318\",\"v321\",\"v327\")\n\nDescr <- Vars[-c(1:3),3]\nVariablen <- as.character(Vars[-c(1:3),1])\n\nnVars <- c(\"p_inklusion\",\"gewfake\",\"pointint\",\"bikregbez\",\"bikbula\",\"regbez\",\"v942\",\"v762\",\"v977\",\"deutsch\",\"v976\")\nNind <- match(nVars,Variablen)\nVariablen <- Variablen[-Nind]\n\n\nErgList <-list()\nn_West <- vector()\nfor(j in 1:length(Variablen)){\n  nr       <- match(Variablen[j],colnames(x))\n  x <- x_ALL\n  x        <- subset(x,is.na(x[,nr])==0)  # Zeilen mit missings in Variable werden gelÃ¶scht\n\n  #---------------------------------------#\n  # Compute mean etc for western Germany\n  #---------------------------------------#\n\n  # West\n  N_West    <- 8497      # Zahl der Gemeinden (PSUs); aus GEM2007.sav + Berlin-West\n  K_West    <- 55701259  # Zahl der 18+ Einwohner (SSUs); aus 6706109495_Allokationsprotokoll.txt\n  Mh_West   <- 111       # Zahl der Sample Points; aus 6706109495_Allokationsprotokoll.txt\n\n\n  x_West    <- subset(x,x$v5==1)\n  tab_lev <- table(x_West[,nr])\n  n_West   <- nrow(x_West)\n  erg_West <- data.frame(Variable=Variablen[j],\n                         Level=names(tab_lev),\n                         Estimator.mean=NA,\n                         Variance.estimator=NA,\n                         Estimator.for.sigma.2=NA,\n                         Sampling.variance=NA\n  )\n\n  for (i in 1:length(tab_lev)){\n    ys_West   <- as.numeric(x_West[,nr]==names(tab_lev)[i])\n\n    erg_West[i,3:6] <- sig_hat(ys=ys_West,\n                               Mi=x_West$Mi,\n                               PSU=x_West$PSU,\n                               sPSU=x_West$v762,\n                               N=N_West,\n                               K=K_West)\n  }\n  ErgList[[j]] <-  erg_West\n}\n\n#---------------------------------------#\n# Produce a table\n#---------------------------------------#\n\n# names(ErgList) <- Descr\n\nErg_df <- do.call(rbind,ErgList)\n\nErg_df$Quot <- Erg_df[,5]/Erg_df[,6]\n\n\n# Estimator for Deff\nErg_df$Deff <- with(Erg_df,Variance.estimator/Estimator.for.sigma.2*n_West)\n\n# Estimator for Deff(s^2)\n\nErg_df$Deff_s2 <- with(Erg_df,Variance.estimator/Sampling.variance*n_West)\n\n#---------------------------------------#\n# Save the data\n#---------------------------------------#\n\nsetwd(path)\nattr(Erg_df,\"Info\") <- paste(author,scriptname,date())\nsave(Erg_df,file=\"Erg_df_weightALLB10.RData\")\n\n\n#---------------------------------------#\n# Analysis\n#---------------------------------------#\n\ns2 <- Erg_df[Erg_df$Variable==\"v975\",\"Estimator.for.sigma.2\"]\n\n\nm_smp <- tapply(x_West$v762,x_West$v975,function(x)length(unique(x)))\nn_smp <- length(unique(x_West$v762))\ns2y <- (m_smp*(n_smp-m_smp))/(n_smp*(n_smp-1))\n\nCompare <- data.frame(s2,s2y)\n\nxtable(Compare,digits=4)\n\nkable(Compare,digits=4)\n\nsetwd(path)\nsave(Ergbula,file=\"Ergbula.RData\")\n\n\n\ntapply(x_ALL$v762,x_ALL$v975,function(x)length(table(x)))\n\nxtable(erg_West)\n\n\n\nErg_df[Erg_df$Variable==\"v975\",]\n\nsummary(Quot)\nErg_df[which.max(Quot),]\nsort(Quot)\nErg_df[Quot>1.5,]\nErg_df[Quot<.9,]\n\n\nErg_df[Erg_df$Variable==\"v327\",]\n\n#---------------------------------------#\n# normalization\n#---------------------------------------#\n\n\n# http://stackoverflow.com/questions/15215457/standardize-data-columns-in-r\n",
    "created" : 1435905623631.000,
    "dirty" : false,
    "encoding" : "UTF-8",
    "folds" : "",
    "hash" : "3956902448",
    "id" : "7296FFAE",
    "lastKnownWriteTime" : 1435908433,
    "path" : "J:/Work/Statistik/Kolb/Paper/Gewichtung/Rcode/rcodePaper/WeightALL_C_ComputeWeights.R",
    "project_path" : null,
    "properties" : {
        "tempName" : "Untitled1"
    },
    "relative_order" : 1,
    "source_on_save" : false,
    "type" : "r_source"
}
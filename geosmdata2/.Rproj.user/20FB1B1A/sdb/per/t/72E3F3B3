{
    "contents" : "##################################\n# Georeferenzierung\n# Jan-Philipp Kolb\n# 29.01.2015\n#\n# Vortrag Koeln\n#\n##################################\n\n\n#-----------------------------------------------------------#\n# Read libraries\n#-----------------------------------------------------------##\n\nlibrary(osmar)\napi <- osmsource_api()\n\nlibrary(wordcloud)\nlibrary(ggmap)\nlibrary(maptools)\nlibrary(SoDA)\n\n\n#------------------------#\n# define paths\n#------------------------#\n\ngraph.path <- \"J:/Work/Statistik/Kolb/Vorträge/20150115_GeoreferenzierungKöln/Folien/figure\"\ndata.path <- \"D:/Daten/GeoDaten\"\n\ndata.path4 <-\"D:/Daten/GeoDaten/\"\n\ndata.path2 <- paste(data.path4,\"/Heidelberg\",sep=\"\")\n\n\n#-----------------------------------------------------------#\n# load data\n#-----------------------------------------------------------##\n\n\nsetwd(data.path4)\nPLZ <- readShapePoly(\"post_pl.shp\")\n\n#-----------------------------------------------------------#\n# download data\n#-----------------------------------------------------------##\n\napi <- osmsource_api()\nKoeln <- geocode(\"Gesis Koeln\")\nbb <- center_bbox(Koeln$lon,Koeln$lat,1200, 1200)\nua <- get_osm(bb, source = api)\n\n# save data\nsetwd(data.path)\nsave(ua,file=\"ua_GesisKoeln.RData\")\nload(\"ua_GesisKoeln.RData\")\n\n#-----------------------------------------------------------#\n# get shapefiles buildings\n#-----------------------------------------------------------##\n\n\nGebPlotten <- function(ua,what){\n  ua_ids <- find(ua, way(tags(k == \"building\")))\n  ua_ids2 <- find_down(ua, way(ua_ids))\n  bg <- subset(ua, ids = ua_ids2)\n  \n  bg_erg <- as_sp(bg, \"polygons\")  \n  return(bg_erg)\n}\n\nbg_poly_Koeln <- GebPlotten(ua,what=\"building\")\n\nsetwd(graph.path)\n\npng(\"osmar_building_KoelnBurgmauer.png\")\nmai=c(0,0,0,0)\nplot(bg_poly_Koeln)\ndev.off()\n\n#-----------------------------------------------------------#\n# download data\n#-----------------------------------------------------------##\n\ncity <- geocode(\"Hamburg\")\nbb <- center_bbox(city$lon,city$lat,1200, 1200)\nua <- get_osm(bb, source = api)\n\n# save data\nsetwd(data.path)\nsave(ua,file=\"ua_Hamburg.RData\")\nload(\"ua_GesisKoeln.RData\")\n\n#-----------------------------------------------------------#\n# download data - more automatecally\n#-----------------------------------------------------------##\n\nxname <- \"Heidelberg\"\ncity_p <- PLZ[PLZ$PLZORT99==xname,]\n\nbb_mas <- bbox(city_p)\n\nDist_m_x <- distm(bb_mas[,1],c(bb_mas[1,2],bb_mas[2,1]))\n# ca 5 km\nDist_m_y <- distm(bb_mas[,1],c(bb_mas[1,1],bb_mas[2,2]))\nDist <- apply(bb_mas,1,diff) \nxstep <- seq(bb_mas[1,1],bb_mas[1,2],by=Dist[1]/5)\nystep <- seq(bb_mas[2,1],bb_mas[2,2],by=Dist[2]/5)\npoinTs <- expand.grid(xstep,ystep)\n\nsetwd(data.path2)\n\nfor (i in 23:nrow(poinTs)){\n  bb <- center_bbox(poinTs[i,1],poinTs[i,2],Dist_m_x/5, Dist_m_y/5)\n  # mean(runif(sample(1:100000,1)))\n  ua=get_osm(bb, source = api)\n  \n  eval(parse(text=paste(\"save(ua,file='ua\",xname,i,\".RData')\",sep=\"\")))\n  i <- i+1\n  cat(i, \"von \",nrow(poinTs),\"/n\")\n}\n\n#-----------------------------------------------------------#\n# download data - more automatecally & get more information\n#-----------------------------------------------------------##\n\nxname <- \"Weinheim\"\ncity_p <- PLZ[PLZ$PLZORT99==xname,]\n\nbb_mas <- bbox(city_p)\n\nDist_m_x <- distm(bb_mas[,1],c(bb_mas[1,2],bb_mas[2,1]))\nDist_m_x2 <- geoDist(lat1=bb_mas[2,1],\n                     lon1=bb_mas[1,1],\n                     lat2=bb_mas[2,1],\n                     lon2=bb_mas[1,2])\n# ca 5 km\nDist_m_y <- distm(bb_mas[,1],c(bb_mas[1,1],bb_mas[2,2]))\nDist <- apply(bb_mas,1,diff) \nxstep <- seq(bb_mas[1,1],bb_mas[1,2],by=Dist[1]/5)\nystep <- seq(bb_mas[2,1],bb_mas[2,2],by=Dist[2]/5)\npoinTs <- expand.grid(xstep,ystep)\n\n\ngeoDist(poinTs[1,1],poinTs[1,2],poinTs[2,1],poinTs[2,2])\n\n#-----------------------------------------------------------#\n# visualisation\n#-----------------------------------------------------------##\n\npar(mai=c(0,0,0,0))\nplot(city_p)\npoints(poinTs,pch=20)\npoints(poinTs[21,],pch=20,col=\"red\")\npoints(poinTs[22,],pch=20,col=\"purple\")\npoints(poinTs[10,],pch=20,col=\"green\")\npoints(poinTs[24,],pch=20,col=\"green\",cex=3)\n\nabline(h=(poinTs[1,2]+poinTs[7,2])/2)\nabline(h=(poinTs[7,2]+poinTs[13,2])/2)\n\n\n\n#-----------------------------------------------------------#\n# extract information\n#-----------------------------------------------------------##\n\n\ntagsK <- ua$nodes$tags$k\n\ntagsV <- ua$nodes$tags$v\n\nind_photo <- which(tagsV==\"photography\")\n\nind_restaurant <- which(tagsV==\"restaurant\")\n\nind_strasse <- which(tagsK==\"addr:street\")\n\nStrassen <- as.character(tagsV[ind_strasse])\nStrassen <- gsub(\"ÃŸ\",\"ss\",Strassen)\nStrassen <- gsub(\"Ã¶\",\"oe\",Strassen)\nStrassen <- gsub(\"Ã¼\",\"ue\",Strassen)\nStrassen <- gsub(\"Ã¤\",\"ae\",Strassen)\n\nsetwd(graph.path)\n\npng(\"StrassenGESISKoeln.png\")\npar(mai=c(0,0,0,0))\nwordcloud(Strassen)\ndev.off()\n\n#-----------------------------------------------------------#\n# Links\n#-----------------------------------------------------------##\n\n\n# http://geospaced.blogspot.co.uk/2013/10/refugee-camp-spatial-analysis.html\n# http://seenthis.net/messages/187371\n\n\n  # to introduce pauses:\n# http://shanelynn.ie/index.php/massive-geocoding-with-r-and-google-maps/\n\n#-----------------------------------------------------------#\n# Code aus anderer Quelle\n#-----------------------------------------------------------##\n\n\n# this pulls the data from the OSM-Api:\nmydistrict <- get_osm(relation(85647), full = TRUE)\n\n# make a spatial object:\nmydistrict_sp <- as_sp(mydistrict, what = 'lines')\nsummary(mydistrict_sp)\n\n# just for fun i'll plot some bubbles on my map:\nmydata <- data.frame(x = runif(100, 12.300, 12.550),\n                     y = runif(100, 47.300, 47.550),\n                     data = sample(1:30, 100, replace = T))\nmydata_sp <- SpatialPointsDataFrame(mydata[, c('x', 'y')], data=mydata,\n                                    proj4string=CRS('+proj=longlat +datum=WGS84'))\n# see what's in there:\nsummary(mydata_sp)\n\n# plot:\nsetwd(tempdir())\npdf(\"testOSM.pdf\")\npar(oma = rep(0, 4))\nmycex = (mydata_sp@data[,'data']/max(mydata_sp@data[,'data'])*2)^2\nplot(mydistrict_sp, axes = T)\ncolpts = rgb(0.2, 0.5, 0.4, alpha = 0.6)\npoints(x = mydata_sp@coords[,'x'],\n       y = mydata_sp@coords[,'y'],\n       cex = mycex, col = 0,\n       pch = 21, bg = colpts)\ntitle('MyData in MyDistrict')\n\n# legend:\nl1 = min(mydata_sp@data[,'data'])\nl2 = round(mean(mydata_sp@data[,'data']), 0)\nl3 = max(mydata_sp@data[,'data'])\nl = c(l1, l2, l3)\nlcex = (c(l/l3*2))^2\npoints(x = rep(12, 3), y = seq(47.7, 47.6, -.05),\n       cex = lcex, col = 0,\n       pch = 21, bg = colpts)\ntext(l, x = rep(12, 3) +.045, y = seq(47.7, 47.6, -.05))\n\ngraphics.off()",
    "created" : 1429877392973.000,
    "dirty" : false,
    "encoding" : "UTF-8",
    "folds" : "",
    "hash" : "2365645196",
    "id" : "72E3F3B3",
    "lastKnownWriteTime" : 1426783867,
    "path" : "J:/Work/Statistik/Kolb/Vorträge/20150115_GeoreferenzierungKöln/Rskripte/GeoCodeKoeln_C_osmar.R",
    "project_path" : null,
    "properties" : {
    },
    "relative_order" : 7,
    "source_on_save" : false,
    "type" : "r_source"
}
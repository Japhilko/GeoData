---
title: "Use OSM API overpass"
author: "Jan-Philipp Kolb"
date: "12/06/2015"
output: slidy_presentation
---

```{r,echo=F}
Examples <- F
```

## Introduction

- The package [osmar](http://cran.r-project.org/web/packages/osmar/index.html) provides good possibilities to download information about small areas from [OpenStreetMap](http://www.openstreetmap.org/). 

- With the this [link](https://www.openstreetmap.org/export) it is possible to export data directly from OpenStreetMap. 

- You will get [.osm](http://wiki.openstreetmap.org/wiki/OSM_XML)-data. See the [osmar-manual](http://osmar.r-forge.r-project.org/RJpreprint.pdf) to work with this data.

But Sometimes you might want to have information only on one 
[specific topic](http://www.r-bloggers.com/r-streets-of-france/)
and you want that information for a 
[bigger area](https://help.openstreetmap.org/questions/34080/using-r-to-get-lat-and-lon-from-osm_ids-without-assistance-of-external-software-eg-qgis). 
In this case 
[osmar](http://journal.r-project.org/archive/2013-1/eugster-schlesinger.pdf)
might not be the perfect solution.  

## Download specific information

There are several ways to download information from OpenStreetMap. On of these possibilities is the mapquest Xapi Service:

<http://open.mapquestapi.com/xapi/>

To get information, you have to specify a bounding box:

[left,bottom,right,top]

- [Defining an adequate bounding box](http://gis.stackexchange.com/questions/46954/clip-spatial-object-to-bounding-box-in-r)

## Alternatives/Example to define bounding box

[left,bottom,right,top]

or:

[east,south,west,north]

or:

[lon.min,lat.min,lon.max,lat.max]

for example Mannheim Seckenheim:

[8.5382,49.4573,8.5808,49.4759]



## Download Link

Links to download information from this section 

(pubs in this case):

```{r,eval=F}
"http://open.mapquestapi.com/xapi/api/0.6/node%5B
amenity=pub%5D%5Bbbox=8.5382,49.4573,8.5808,49.4759%5D"
```



## Using R to download information:

The library [XML](http://cran.r-project.org/web/packages/XML/index.html) is essential to perform the following steps:

```{r,eval=Examples}
install.packages("XML")
library(XML)
```


Now the command xmlParse can be used to download information:

```{r,eval=Examples}
ab <- xmlParse("http://open.mapquestapi.com/xapi/api/0.6/node%5B
               amenity=pub%5D%5Bbbox=-77.041579,38.885851,
               -77.007247,38.900881%5D")

bbox <- "-77.041579,38.885851,-77.007247,38.900881"
abc <- xmlParse(paste("http://open.mapquestapi.com/xapi/api/0.6/node%5B
                      amenity=pub%5D%5Bbbox=",
                      bbox,"%5D",sep=""))
```

## Finding a specific place

```{r,eval=Examples}
library(ggmap)
  # lon - east west
  # lat - south north
MAcode1 <- geocode("Mannheim Sandhofen")
MAcode2 <- geocode("Mannheim Rheinau")

MAcode3 <- geocode("Mannheim Schloss")
MAcode4 <- geocode("Mannheim Wallstadt")

  # [left,bottom,right,top]
bbox2 <- paste(MAcode3$lon,MAcode2$lat,MAcode4$lon,MAcode1$lat,sep=",")
abcd <- xmlParse(paste("http://open.mapquestapi.com/xapi/api/0.6/node%5B
                       amenity=pub%5D%5Bbbox=",
                       bbox2,"%5D",sep=""))
```

## Getting a bounding box from administrative areas. 

- [Adminstrative Areas](https://en.wikipedia.org/wiki/Administrative_division) from [GADM](http://www.gadm.org/). 

```{r,eval=Examples}
library(raster)
LUX3 <- getData('GADM', country='LUX', level=3)

LUXT <- LUX3[LUX3@data$NAME_3=="Troisvierges",]
```

```{r,eval=Examples}
library(sp)
bLUXT <- bbox(LUXT)
bbox3 <- paste(bLUXT[1,1],bLUXT[2,1],bLUXT[1,2],bLUXT[2,2],sep=",")
abct <- xmlParse(paste("http://open.mapquestapi.com/xapi/api/0.6/node%5B
                       amenity=pub%5D%5Bbbox=",
                       bbox3,"%5D",sep=""))
```


## Available Map Features

An overview of the different map features is available on the [OSM wiki](http://wiki.openstreetmap.org/wiki/Map_Features).


![pic](https://www.mapbox.com/guides/img/pages/OT-map-features-wiki.png)

## Usage of overpass API

- An very good alternative for [xapi](http://wiki.openstreetmap.org/wiki/Xapi) is the [overpass API](http://wiki.openstreetmap.org/wiki/Overpass_API). [Here](http://wiki.openstreetmap.org/wiki/DE:Overpass_API/Beispielsammlung#Stra.C3.9Fenliste) are some use cases available.


- [Language Guide](http://wiki.openstreetmap.org/wiki/DE:Overpass_API/Language_Guide) and [convert form](http://overpass-api.de/convert_form.html)

- Here is the [query form](http://overpass-api.de/query_form.html)

- [Overpass-turbo](https://www.mapbox.com/guides/overpass-turbo/) is an alternative, but no API. 

- [OpenAlfaPlot]((ttp://blog-en.openalfa.com/how-to-query-openstreetmap-using-the-overpass-api)) on how to query Openstreetmap using the Overpass API. 


- [About overpass API in German](http://podcast.openstreetmap.de/2012/12/28/osmde009-osm-talk-die-overpass-api/)

- An [example](http://statistik-stuttgart.de/r-osm-maps-with-osmar-and-the-overpass-x-api/) on how to use the [overpass API](http://wiki.openstreetmap.org/wiki/Overpass_API) with R.  

## The overpass API

You can get all streets in Troisdorf with the following command:

```{r,eval=Examples}
Troisdorf <- xmlParse("http://www.overpass-api.de/api/interpreter?data=
                      area[name=\"Troisdorf\"];
                      way(area)[highway][name];out;")
```

[Information on how to organise the command line.](http://overpass-api.de/command_line.html)


Example: Find all cinemas in Bonn which are at most 100m away from bus stops 

```{r,eval=Examples}
CinemasBonn <- xmlParse("http://www.overpass-api.de/api/interpreter?data=
                        area[name=\"Bonn\"];node(area)[highway=bus_stop];
                        node(around:100)[amenity=cinema];out;")
```

## All restaurants in Ilvesheim:
```{r,eval=Examples}
rest_IH <- xmlParse("http://www.overpass-api.de/api/interpreter?data=
                                area[name=\"Ilvesheim\"];node(area)
                                [amenity=restaurant];out;")
```

In R We can use the powerful `osmar`-package: 

```{r,eval=F}
saveXML(rest_IH,file="rest_IH.XML")
library("osmar")
ilv <- get_osm(complete_file(), source = osmsource_file("rest_IH.XML"))

rest <- find(ilv, node(tags(k == "amenity")))

plot_nodes(ilv,col = "red")
```



## Find restaurants in Feudenheim (admin_level=9)

```{r,eval=Examples}
rest_FD <- xmlParse("http://www.overpass-api.de/api/interpreter?data=
                                 area[name=\"Feudenheim\"];node(area)
                                 [amenity=restaurant];out;")
```

## Get the administrative boundaries for the city of Mannheim:

```{r,eval=Examples}
boundaryMA <- xmlParse("http://www.overpass-api.de/api/interpreter?data=
                       area[name=\"Mannheim\"];way(area)
                       [boundary=administrative];out;")
```


```{r,echo=F,eval=F}
data.path <- "J:/Work/Statistik/Kolb/Paper/UseOSMdata/data/XML"
setwd(data.path)
saveXML(boundaryMA,file="boundaryMA.xml")
```

```{r,eval=F,echo=F}
bound <- get_osm(complete_file(), source = osmsource_file("boundaryMA.xml"))
bound_MA <- find(bound, way(tags(k == "boundary")))
bg_ids <- find_down(bound, way(bound_MA))
bg <- subset(bound, ids = bg_ids)
bg
bg_poly <- as_sp(bg, "polygons")
```


## More than one condition:

```{r,eval=Examples}
boundMA <- xmlParse("http://www.overpass-api.de/api/interpreter?data=
                    area[name=\"Mannheim\"];way(area)
                    [boundary=administrative][admin_level=9];out;")
```



## Output options

More about the [Query language](http://wiki.openstreetmap.org/wiki/Overpass_API/Overpass_QL) used to get information via the overpass API.


```{r,eval=Examples}
geomMA <- xmlParse("http://www.overpass-api.de/api/interpreter?data=
                   area[name=\"Mannheim\"];way(area)
                   [boundary=administrative];out geom;")
```

Five different output formats are possible, a description is available [here](http://overpass-api.de/output_formats.html).

## Download csv

```{r,eval=F}
"http://overpass-api.de/api/interpreter?data=
[out:csv(::'type',::'id')];area[name='Feudenheim'];
node(area)[amenity=restaurant];out;)"
```


This can be also used to load data directly into the workspace of R:

```{r,eval=Examples}
info <- read.csv("http://overpass-api.de/api/interpreter?data=
                 [out:csv(::\"type\",::\"id\")];area
[name=\"Feudenheim\"];node(area)
[amenity=restaurant];out;")
```

## Download information about Bayern
```{r,eval=Examples}
infoBayern <- xmlParse("http://www.overpass-api.de/api/interpreter?data=
                       area[name=\"Bayern\"];way(area)
                       [amenity=charging_station];out;")
```


## Processment of XML data

One way to process information from a XML is to use the command [xmlToList](http://www.inside-r.org/packages/cran/XML/docs/xmlToList)

```{r,eval=Examples}
root <- xmlRoot(boundMA)
infoAttrs <- xmlSApply(root, xmlAttrs)

```

xpath

- [Xpath Introduction](http://www.data2type.de/xml-xslt-xslfo/xpath/xpath-einfuehrung/)

- [xpath axes](http://www.w3schools.com/xpath/xpath_axes.asp)

- [Gaston Sanchez - how to work with web data](http://gastonsanchez.com/blog/resources/2014/05/12/Web-data.html)



## Resources

- [All streets project](http://benfry.com/writing/archives/category/allstreets)


- [Clipping spatial data in R:](http://robinlovelace.net/r/2014/07/29/clipping-with-r.html)

- [Other information](http://gis.stackexchange.com/questions/18124/how-do-i-download-specific-openstreetmap-data-by-tag)

## More information on getting data from the web with R

- First off all the following website <http://gastonsanchez.com/work/webdata/>

- There is a CRAN task view on [Web Technologies and Services](http://cran.r-project.org/web/views/WebTechnologies.html)

- Further examples - [Streets of ...](http://www.r-bloggers.com/r-streets-of-france/)


- [Converting osm file to shapefile in R](http://gis.stackexchange.com/questions/115911/converting-osm-file-to-shapefile-or-data-frame-in-r)

- [Video - Intro to overpass](https://www.youtube.com/watch?v=lwlxpG4pGJs)

- [Video - Intro overpass II](https://www.youtube.com/watch?v=LxWEHQ2DpI0)

- [Video - Mobile Karten](https://www.youtube.com/watch?v=WxsP9cG_Vcs)

## Further links

- [Open layers](http://openlayers.org/)

---
title: "Use OSM API overpass"
author: "Jan-Philipp Kolb"
date: "12. Juni 2015"
output: html_document
---

## Introduction

The package [osmar](http://cran.r-project.org/web/packages/osmar/index.html) provides good possibilities to download information about small areas from  
[OpenStreetMap](http://www.openstreetmap.org/). But there are shortcommings too. Sometimes you might want to have information only on one specific topic and you want that information for a bigger area. In this case osmar might not be the perfect solution.  

## Download specific information

There are several ways to download information from OpenStreetMap. On of these possibilities is the mapquest Xapi Service:

<http://open.mapquestapi.com/xapi/>

To get information, you have to specify a bounding box:

[left,bottom,right,top]

or:

[east,south,west,north]

or:

[lon.min,lat.min,lon.max,lat.max]


for example Mannheim Seckenheim:

[8.5382,49.4573,8.5808,49.4759]

Links to download information from this section (pubs in this case):

<http://open.mapquestapi.com/xapi/api/0.6/node%5Bamenity=pub%5D%5Bbbox=8.5382,49.4573,8.5808,49.4759%5D>

## Using R to download information:

The library [XML](http://cran.r-project.org/web/packages/XML/index.html) is essential to perform the following steps:

```{r}
library(XML)
```


Now the command xmlParse can be used to download information:

```{r}
ab <- xmlParse("http://open.mapquestapi.com/xapi/api/0.6/node%5Bamenity=pub%5D%5Bbbox=-77.041579,38.885851,-77.007247,38.900881%5D")

bbox <- "-77.041579,38.885851,-77.007247,38.900881"
abc <- xmlParse(paste("http://open.mapquestapi.com/xapi/api/0.6/node%5Bamenity=pub%5D%5Bbbox=",
                      bbox,"%5D",sep=""))
```

Finding a specific place

```{r}
library(ggmap)
  # lon - east west
  # lat - south north
MAcode1 <- geocode("Mannheim Sandhofen")
MAcode2 <- geocode("Mannheim Rheinau")

MAcode3 <- geocode("Mannheim Schloss")
MAcode4 <- geocode("Mannheim Wallstadt")

  # [left,bottom,right,top]
bbox2 <- paste(MAcode3$lon,MAcode2$lat,MAcode4$lon,MAcode1$lat,sep=",")
abcd <- xmlParse(paste("http://open.mapquestapi.com/xapi/api/0.6/node%5Bamenity=pub%5D%5Bbbox=",
                       bbox2,"%5D",sep=""))
```

Getting a bounding box from administrative areas. Which are downloaded from GADM. 

```{r}
library(raster)
LUX3 <- getData('GADM', country='LUX', level=3)

LUXT <- LUX3[LUX3@data$NAME_3=="Troisvierges",]
```

```{r}
library(sp)
bLUXT <- bbox(LUXT)
bbox3 <- paste(bLUXT[1,1],bLUXT[2,1],bLUXT[1,2],bLUXT[2,2],sep=",")
abct <- xmlParse(paste("http://open.mapquestapi.com/xapi/api/0.6/node%5Bamenity=pub%5D%5Bbbox=",
                       bbox3,"%5D",sep=""))
```


An overview of the different map features is available on the [OSM wiki](http://wiki.openstreetmap.org/wiki/Map_Features).

## The overpass API

Instead of xapi you should use the overpass API. [Here](http://wiki.openstreetmap.org/wiki/DE:Overpass_API/Beispielsammlung#Stra.C3.9Fenliste) are some use cases available.

You can get all streets in Troisdorf with the following command:

```{r}
Troisdorf <- xmlParse("http://www.overpass-api.de/api/interpreter?data=area[name=\"Troisdorf\"];way(area)[highway][name];out;")
```

[Information on how to organise the command line.](http://overpass-api.de/command_line.html)


Example: Find all cinemas in Bonn which are at most 100m away from bus stops 

```{r}
CinemasBonn <- xmlParse("http://www.overpass-api.de/api/interpreter?data=area[name=\"Bonn\"];node(area)[highway=bus_stop];node(around:100)[amenity=cinema];out;")
```

All restaurants in Ilvesheim:
```{r}
restaurantIlvesheim <- xmlParse("http://www.overpass-api.de/api/interpreter?data=area[name=\"Ilvesheim\"];node(area)[amenity=restaurant];out;")
```

Find restaurants in Feudenheim (admin_level=9)

```{r}
restaurantFeudenheim <- xmlParse("http://www.overpass-api.de/api/interpreter?data=area[name=\"Feudenheim\"];node(area)[amenity=restaurant];out;")
```

Get the administrative boundaries for the city of Mannheim:
```{r}
boundaryMA <- xmlParse("http://www.overpass-api.de/api/interpreter?data=area[name=\"Mannheim\"];way(area)[boundary=administrative];out;")
```

for more examples see:

<http://wiki.openstreetmap.org/wiki/Overpass_API/Overpass_QL>

## Processment of XML data

One way to process information from a XML is to use the command [xmlToList](http://www.inside-r.org/packages/cran/XML/docs/xmlToList)

## Links

Usage of overpass API:

<http://statistik-stuttgart.de/r-osm-maps-with-osmar-and-the-overpass-x-api/>

<https://www.mapbox.com/guides/overpass-turbo/>

About overpass API in German:

<http://podcast.openstreetmap.de/2012/12/28/osmde009-osm-talk-die-overpass-api/>

Working with XML files:

<http://www.informit.com/articles/article.aspx?p=2215520>

<http://gastonsanchez.com/work/webdata/getting_web_data_r4_parsing_xml_html.pdf>


<http://www.w3schools.com/xquery/>

Defining an adequate bounding box:

<http://gis.stackexchange.com/questions/46954/clip-spatial-object-to-bounding-box-in-r>


All streets project:

<http://benfry.com/writing/archives/category/allstreets>



Clipping spatial data in R:

<http://robinlovelace.net/r/2014/07/29/clipping-with-r.html>

Other information:

<http://gis.stackexchange.com/questions/18124/how-do-i-download-specific-openstreetmap-data-by-tag>

## More information on getting data from the web with R

First off all I would recomend the following website <http://gastonsanchez.com/work/webdata/>

There is a CRAN task view on [Web Technologies and Services](http://cran.r-project.org/web/views/WebTechnologies.html)



<http://www.data2type.de/xml-xslt-xslfo/xpath/xpath-einfuehrung/>  

<http://www.w3schools.com/xpath/xpath_axes.asp>

<http://gastonsanchez.com/blog/resources/2014/05/12/Web-data.html>



Streets of ...

<http://statistik-stuttgart.de/r-street-of-france/>
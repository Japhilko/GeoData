---
title: "Use xapi"
author: "Jan-Philipp Kolb"
date: "12. Juni 2015"
output: html_document
---

```{r,eval=F,echo=F}
path <- "C:/Users/kolbjp/Documents/GitHub/GeoData/workshops"
setwd(path)
```



```{r}
library(XML)
```


## Download specific information

mapquest Xapi Service:

<http://open.mapquestapi.com/xapi/>


Organisation of bounding box:

[left,bottom,right,top]

or:

[east,south,west,north]

or:

[lon.min,lat.min,lon.max,lat.max]


for example Mannheim Seckenheim:

[8.5382,49.4573,8.5808,49.4759]

Links to download information from this section:

<http://open.mapquestapi.com/xapi/api/0.6/node%5Bamenity=pub%5D%5Bbbox=8.5382,49.4573,8.5808,49.4759%5D>

<http://open.mapquestapi.com/xapi/api/0.6/node%5Bamenity=pub%5D%5Bbbox=-77.041579,38.885851,-77.007247,38.900881%5D>

```{r}
ab <- xmlParse("http://open.mapquestapi.com/xapi/api/0.6/node%5Bamenity=pub%5D%5Bbbox=-77.041579,38.885851,-77.007247,38.900881%5D")

bbox <- "-77.041579,38.885851,-77.007247,38.900881"
abc <- xmlParse(paste("http://open.mapquestapi.com/xapi/api/0.6/node%5Bamenity=pub%5D%5Bbbox=",bbox,"%5D",sep=""))
```

Finding a specific place

```{r}
library(ggmap)
  # lon - east west
  # lat - south north
MAcode1 <- geocode("Mannheim Sandhofen")
MAcode2 <- geocode("Mannheim Rheinau")

MAcode3 <- geocode("Mannheim Schloss")
MAcode4 <- geocode("Mannheim Wallstadt")

  # [left,bottom,right,top]
bbox2 <- paste(MAcode3$lon,MAcode2$lat,MAcode4$lon,MAcode1$lat,sep=",")
abcd <- xmlParse(paste("http://open.mapquestapi.com/xapi/api/0.6/node%5Bamenity=pub%5D%5Bbbox=",bbox2,"%5D",sep=""))
```



```{r}
library(raster)
LUX3 <- getData('GADM', country='LUX', level=3)

LUXT <- LUX3[LUX3@data$NAME_3=="Troisvierges",]
```

```{r}
library(sp)
bLUXT <- bbox(LUXT)
bbox3 <- paste(bLUXT[1,1],bLUXT[2,1],bLUXT[1,2],bLUXT[2,2],sep=",")
abct <- xmlParse(paste("http://open.mapquestapi.com/xapi/api/0.6/node%5Bamenity=pub%5D%5Bbbox=",bbox3,"%5D",sep=""))
```


```{r}
setwd("D:/Daten/Daten/GeoDaten")
library(rgdal)
PLZ <- readOGR ("post_pl.shp","post_pl")
MA <- PLZ[PLZ@data$PLZORT99=="Mannheim",]
bMA <- bbox(MA)

MA2 <- PLZ[PLZ@data$PLZ99=="68159",]
bMA2 <- bbox(MA2)

bbox4 <- paste(bMA[1,1],bMA[2,1],bMA[1,2],bMA[2,2],sep=",")
abcm <- xmlParse(paste("http://open.mapquestapi.com/xapi/api/0.6/node%5Bamenity=pub%5D%5Bbbox=",bbox4,"%5D",sep=""))
```


```{r}
List_abcm <- xmlToList(abcm)

List_abcm[[1]][2]

List_abcm[[2]][2]
```


```{r}
xList<- lapply(List_abcm,unlist)

ListEl <- xList[[1]]
ListEl[which(ListEl=="name")+1]
```



```{r}
abce <- xmlParse("http://open.mapquestapi.com/xapi/api/0.6/node[amenity=pub][bbox=8.41420088819042,49.467729452325514,8.551529989747436,49.517905125443455]")
```

## Getting different map features

<http://wiki.openstreetmap.org/wiki/Map_Features>
```{r}

bb_x=bbox(MA)

object_x="leisure=playground"

request_xapi <- function(bb_x,object_x){
  bbox_x <- paste(bb_x[1,1],bb_x[2,1],bb_x[1,2],bb_x[2,2],sep=",")
  xapi_x <- xmlParse(paste("http://open.mapquestapi.com/xapi/api/0.6/node%5B",object_x,"%5D%5Bbbox=",bbox_x,"%5D",sep=""))
}

MA_pg <-  request_xapi(bb_x=bbox(MA),object_x="leisure=playground")


MA_bakery <-  request_xapi(bb_x=bbox(MA),object_x="shop=bakery")
```

## How to create a bounding box:

```{r}
library(ggmap)

gc_HD <- geocode("Heidelberg")

box.value <- 0.0075

gc_HD_min <- gc_HD - box.value
gc_HD_max <- gc_HD + box.value

# [lon.min,lat.min,lon.max,lat.max]
bbox_x <- paste(gc_HD_min$lon,gc_HD_min$lat,gc_HD_max$lon,gc_HD_max$lat,sep=",")
object_x="leisure=playground"
xapi_x <- xmlParse(paste("http://open.mapquestapi.com/xapi/api/0.6/node%5B",object_x,"%5D%5Bbbox=",bbox_x,"%5D",sep=""))
```

## Possibility to save results:



## Links

Working with XML files:

<http://www.informit.com/articles/article.aspx?p=2215520>



<http://gis.stackexchange.com/questions/18124/how-do-i-download-specific-openstreetmap-data-by-tag>


Defining an adequate bounding box:

<http://gis.stackexchange.com/questions/46954/clip-spatial-object-to-bounding-box-in-r>

Clipping spatial data in R:

<http://robinlovelace.net/r/2014/07/29/clipping-with-r.html>
